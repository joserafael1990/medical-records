================================================================================
GU√çA DE POL√çTICA DE RETENCI√ìN DE DATOS
CORTEX Medical Records System
================================================================================

üìã CUMPLIMIENTO REGULATORIO:
- LFPDPPP (Ley Federal de Protecci√≥n de Datos Personales)
- NOM-004-SSA3-2012 (Expediente Cl√≠nico - retenci√≥n m√≠nima 5 a√±os)

================================================================================
1. CONCEPTOS CLAVE
================================================================================

RETENCI√ìN:
- Los expedientes m√©dicos se retienen por 5 a√±os desde la √∫ltima consulta
- Los consentimientos de privacidad se retienen por 5 a√±os desde la fecha de consentimiento
- Despu√©s del periodo de retenci√≥n, los datos deben ser ANONIMIZADOS o ELIMINADOS

ANONIMIZACI√ìN:
- Proceso irreversible de eliminaci√≥n de datos personales
- Mantiene datos estad√≠sticos agregados (opcional)
- 3 estrategias disponibles:
  * FULL: Elimina todos los datos personales ‚Üí "[ANONYMIZED]"
  * PARTIAL: Mantiene c√≥digos de diagn√≥stico, elimina narrativas
  * PSEUDO: Reemplaza con pseud√≥nimos (para investigaci√≥n)

RETENCI√ìN LEGAL (LEGAL HOLD):
- Previene la eliminaci√≥n de datos bajo investigaci√≥n legal
- Los registros con retenci√≥n legal NO pueden ser anonimizados
- Debe especificarse la raz√≥n legal

ARCHIVADO:
- Movimiento de registros antiguos a almacenamiento "fr√≠o"
- No afecta la retenci√≥n ni anonimizaci√≥n
- Optimiza el rendimiento del sistema

================================================================================
2. ENDPOINTS API DISPONIBLES
================================================================================

2.1. OBTENER ESTAD√çSTICAS DE RETENCI√ìN
---------------------------------------
GET /api/data-retention/stats

Respuesta:
{
  "success": true,
  "stats": {
    "active_records": 81,              // Registros activos
    "archived_records": 0,             // Registros archivados
    "anonymized_records": 0,           // Registros anonimizados
    "records_on_legal_hold": 0,        // Con retenci√≥n legal
    "ready_for_anonymization": 0,      // Listos para anonimizar
    "expiring_30_days": 0,             // Expiran en 30 d√≠as
    "expiring_90_days": 0              // Expiran en 90 d√≠as
  },
  "doctor_id": 101
}

2.2. OBTENER REGISTROS PR√ìXIMOS A EXPIRAR
------------------------------------------
GET /api/data-retention/expiring?days=90&limit=100

Par√°metros:
- days: Umbral de d√≠as (default: 90)
- limit: M√°ximo de registros (default: 100)

Respuesta:
{
  "success": true,
  "records": [
    {
      "id": 87,
      "patient_id": 102,
      "doctor_id": 101,
      "consultation_date": "2025-10-21T23:18:24",
      "retention_end_date": "2030-10-21T23:18:24",
      "is_archived": false,
      "is_anonymized": false,
      "legal_hold": false,
      "days_until_expiration": 1825
    }
  ],
  "count": 1,
  "days_threshold": 90
}

2.3. ANONIMIZAR UN REGISTRO ESPEC√çFICO
---------------------------------------
POST /api/data-retention/anonymize/{record_id}

Par√°metros (query):
- reason: Raz√≥n para la anonimizaci√≥n (default: "manual_request")
- strategy: Estrategia (full, partial, pseudo - default: "full")

Respuesta exitosa:
{
  "success": true,
  "message": "Registro anonimizado exitosamente",
  "record_id": 87
}

Errores comunes:
- 404: Registro no encontrado o no autorizado
- 400: Registro tiene retenci√≥n legal activa

2.4. ANONIMIZAR TODOS LOS REGISTROS EXPIRADOS
----------------------------------------------
POST /api/data-retention/anonymize-expired?batch_size=100

Par√°metros:
- batch_size: M√°ximo de registros a procesar (default: 100)

Respuesta:
{
  "success": true,
  "message": "Procesados 5 registros",
  "total_processed": 5,
  "success_count": 5,
  "failed_count": 0
}

NOTA: En producci√≥n, esto deber√≠a ejecutarse como un cron job autom√°tico.

2.5. ARCHIVAR UN REGISTRO
--------------------------
POST /api/data-retention/archive/{record_id}

Respuesta:
{
  "success": true,
  "message": "Registro archivado exitosamente",
  "record_id": 87
}

2.6. ESTABLECER RETENCI√ìN LEGAL
--------------------------------
POST /api/data-retention/legal-hold/{record_id}

Par√°metros (query):
- enable: true para activar, false para remover
- reason: Raz√≥n de la retenci√≥n legal (requerido si enable=true)

Ejemplo activar:
POST /api/data-retention/legal-hold/87?enable=true&reason=Demanda%20judicial%20en%20proceso

Respuesta:
{
  "success": true,
  "message": "Retenci√≥n legal activada exitosamente",
  "record_id": 87,
  "legal_hold": true
}

Ejemplo remover:
POST /api/data-retention/legal-hold/87?enable=false&reason=

2.7. EXTENDER PERIODO DE RETENCI√ìN
-----------------------------------
POST /api/data-retention/extend/{record_id}

Par√°metros (query):
- additional_years: A√±os adicionales (1-50)
- reason: Raz√≥n para la extensi√≥n

Ejemplo:
POST /api/data-retention/extend/87?additional_years=2&reason=Tratamiento%20continuo

Respuesta:
{
  "success": true,
  "message": "Periodo de retenci√≥n extendido por 2 a√±os",
  "record_id": 87,
  "additional_years": 2
}

2.8. OBTENER LOGS DE RETENCI√ìN
-------------------------------
GET /api/data-retention/logs

Par√°metros opcionales:
- entity_type: Filtrar por tipo (medical_record, patient, consent)
- entity_id: Filtrar por ID espec√≠fico
- action_type: Filtrar por acci√≥n (archive, anonymize, delete, legal_hold, retention_extended)
- limit: M√°ximo de logs (default: 100)

Respuesta:
{
  "success": true,
  "logs": [
    {
      "id": 1,
      "action_type": "anonymize",
      "entity_type": "medical_record",
      "entity_id": 87,
      "performed_by": 101,
      "performed_at": "2025-10-22T12:00:00",
      "reason": "retention_expired",
      "is_automatic": false,
      "compliance_basis": "LFPDPPP"
    }
  ],
  "count": 1
}

================================================================================
3. CASOS DE USO COMUNES
================================================================================

3.1. CONSULTAR REGISTROS PR√ìXIMOS A EXPIRAR
--------------------------------------------
Ejecutar mensualmente para planificar:

curl -X GET "http://localhost:8000/api/data-retention/expiring?days=90" \
  -H "Authorization: Bearer {token}"

3.2. ANONIMIZAR MANUALMENTE UN REGISTRO
----------------------------------------
Cuando un paciente solicita la eliminaci√≥n de sus datos:

curl -X POST "http://localhost:8000/api/data-retention/anonymize/87?reason=patient_request" \
  -H "Authorization: Bearer {token}"

3.3. RETENCI√ìN LEGAL POR DEMANDA
---------------------------------
Cuando hay un proceso legal:

# Activar retenci√≥n legal
curl -X POST "http://localhost:8000/api/data-retention/legal-hold/87?enable=true&reason=Demanda%20judicial%20caso%20123" \
  -H "Authorization: Bearer {token}"

# Remover retenci√≥n legal al finalizar
curl -X POST "http://localhost:8000/api/data-retention/legal-hold/87?enable=false" \
  -H "Authorization: Bearer {token}"

3.4. EXTENDER RETENCI√ìN POR TRATAMIENTO CONTINUO
-------------------------------------------------
Cuando un paciente contin√∫a en tratamiento:

curl -X POST "http://localhost:8000/api/data-retention/extend/87?additional_years=3&reason=Tratamiento%20cr√≥nico%20en%20curso" \
  -H "Authorization: Bearer {token}"

3.5. PROCESO AUTOM√ÅTICO DE ANONIMIZACI√ìN
-----------------------------------------
Ejecutar como cron job diario/semanal:

curl -X POST "http://localhost:8000/api/data-retention/anonymize-expired?batch_size=100" \
  -H "Authorization: Bearer {token}"

================================================================================
4. ESTRUCTURA DE BASE DE DATOS
================================================================================

4.1. CAMPOS AGREGADOS A medical_records
----------------------------------------
- retention_end_date: Fecha fin de retenci√≥n (consultation_date + 5 a√±os)
- is_archived: Si est√° archivado
- archived_date: Fecha de archivado
- is_anonymized: Si fue anonimizado
- anonymization_date: Fecha de anonimizaci√≥n
- legal_hold: Retenci√≥n legal activa
- legal_hold_reason: Raz√≥n de retenci√≥n legal

4.2. CAMPOS AGREGADOS A privacy_consents
-----------------------------------------
- data_retention_years: A√±os de retenci√≥n (default: 5)
- deletion_scheduled_date: Fecha programada para eliminaci√≥n
- is_anonymized: Si fue anonimizado
- anonymization_date: Fecha de anonimizaci√≥n
- anonymization_reason: Raz√≥n de anonimizaci√≥n

4.3. TABLA data_retention_logs
-------------------------------
Registro de auditor√≠a de todas las acciones de retenci√≥n:
- action_type: Tipo de acci√≥n (archive, anonymize, delete, etc.)
- entity_type: Tipo de entidad (medical_record, patient, consent)
- entity_id: ID de la entidad
- performed_by: Usuario que realiz√≥ la acci√≥n
- performed_at: Fecha/hora de la acci√≥n
- reason: Raz√≥n de la acci√≥n
- compliance_basis: Base legal (LFPDPPP, NOM-004, etc.)
- is_automatic: Si fue acci√≥n autom√°tica o manual
- data_snapshot: Snapshot anonimizado de datos (para auditor√≠a)

4.4. VISTAS SQL
---------------
v_data_retention_expiring:
- Muestra registros que expiran en los pr√≥ximos 90 d√≠as

v_data_retention_stats:
- Estad√≠sticas agregadas de retenci√≥n

================================================================================
5. CONFIGURACI√ìN PARA PRODUCCI√ìN
================================================================================

5.1. CRON JOBS RECOMENDADOS
----------------------------

# Anonimizaci√≥n diaria de registros expirados (2 AM)
0 2 * * * curl -X POST "http://localhost:8000/api/data-retention/anonymize-expired?batch_size=500" \
  -H "Authorization: Bearer {service_token}" >> /var/log/cortex/retention.log 2>&1

# Reporte semanal de registros pr√≥ximos a expirar (Lunes 9 AM)
0 9 * * 1 curl -X GET "http://localhost:8000/api/data-retention/expiring?days=30" \
  -H "Authorization: Bearer {service_token}" | mail -s "Registros pr√≥ximos a expirar" admin@example.com

5.2. MONITOREO
--------------
- Revisar logs de retenci√≥n semanalmente
- Verificar que no haya registros expirados sin anonimizar
- Auditar retenciones legales mensualmente
- Verificar cumplimiento de periodos de retenci√≥n

5.3. BACKUP ANTES DE ANONIMIZACI√ìN
-----------------------------------
IMPORTANTE: Antes de anonimizar, asegurar que:
1. Existe backup completo de la base de datos
2. El periodo de retenci√≥n ha sido cumplido
3. No hay retenciones legales activas
4. Se ha notificado al paciente (si aplica)

================================================================================
6. PREGUNTAS FRECUENTES (FAQ)
================================================================================

Q: ¬øPuedo recuperar datos anonimizados?
A: NO. La anonimizaci√≥n es irreversible. Por eso es cr√≠tico tener backups.

Q: ¬øQu√© pasa si anonimizo por error?
A: Los datos no se pueden recuperar. Usar backups para restaurar.

Q: ¬øCu√°ndo debo usar retenci√≥n legal?
A: Cuando hay demandas, investigaciones o procesos legales activos.

Q: ¬øPuedo eliminar datos antes de 5 a√±os?
A: Solo con solicitud expresa del paciente (derecho de cancelaci√≥n ARCO).

Q: ¬øQu√© estrategia de anonimizaci√≥n usar?
A: 
- FULL: Para cumplimiento estricto de LFPDPPP
- PARTIAL: Para mantener estad√≠sticas m√©dicas
- PSEUDO: Para investigaci√≥n con comit√© de √©tica

Q: ¬øSe anonimiza tambi√©n informaci√≥n de prescripciones y estudios?
A: S√ç. La anonimizaci√≥n afecta TODOS los campos del expediente m√©dico.

Q: ¬øC√≥mo extiendo retenci√≥n para pacientes cr√≥nicos?
A: Usar endpoint /extend/{record_id} cada vez que haya nueva consulta.

================================================================================
7. CUMPLIMIENTO LEGAL
================================================================================

LFPDPPP - Art√≠culos aplicables:
- Art. 11: Periodo de conservaci√≥n de datos
- Art. 22: Derecho de cancelaci√≥n
- Art. 26: Medidas de seguridad
- Art. 34: Obligaci√≥n de eliminar

NOM-004-SSA3-2012:
- 5.5: Conservaci√≥n del expediente cl√≠nico (5 a√±os m√≠nimo)
- 5.6: Eliminaci√≥n despu√©s del periodo de conservaci√≥n

NOM-241-SSA1-2021:
- Trazabilidad de eliminaci√≥n de datos
- Auditor√≠a de acciones de retenci√≥n

================================================================================
8. SOPORTE Y CONTACTO
================================================================================

Para soporte t√©cnico o dudas sobre la pol√≠tica de retenci√≥n:
- Email: support@cortex-medical.com
- Documentaci√≥n: https://docs.cortex-medical.com/retention
- GitHub Issues: https://github.com/joserafael1990/medical-records/issues

================================================================================
VERSI√ìN: 1.0
FECHA: 2025-10-22
AUTOR: CORTEX Development Team
================================================================================

