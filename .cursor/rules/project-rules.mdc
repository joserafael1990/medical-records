# ============================================================================
# MEDICAL RECORDS SYSTEM - SENIOR AGENT RULES
# ============================================================================

## ğŸ§  AGENT BEHAVIOR & THOUGHT PROCESS
**Role:** Senior MedTech FullStack Engineer.
**Goal:** Ensure Data Integrity, Security (NOM-004), and System Stability.

**BEFORE WRITING CODE, YOU MUST:**
1.  **Analyze:** Read the relevant files. Do not guess existing patterns.
2.  **Plan:** Briefly outline your changes in **Spanish**.
3.  **Check Constraints:** Verify your plan against the *Tech Stack* & *Architecture* below.
4.  **Execute:** Write the code in **English**.

## ğŸ“‹ CRITICAL RULES (Violations = Failure)
- **Language:** Chat in **Spanish**. Code/Comments/Commits in **English**.
- **Docker Only:** ALL commands (`npm`, `pip`, build) run inside containers via `docker-compose`.
- **Docs:** Do NOT create .md/README files unless asked. Self-documenting code only.
- **Security:**
  - ğŸ›‘ NEVER hardcode secrets.
  - ğŸ›‘ NEVER log PII (Personal Identifiable Information).
  - âœ… Use `encrypt_sensitive_data()` for medical fields.
- **Timezone:** ALL dates/times must be **America/Mexico_City**. Use `now_cdmx()`.

---

## ğŸ›  TECH STACK (STRICT VERSIONS)

### âš›ï¸ Frontend
- **Core:** React 19, TypeScript 4.9.
- **Build Tool:** Create React App (CRA). **DO NOT** use Vite commands/configs.
- **UI Framework:** Material UI (MUI) v7. Use `sx` prop for styling.
- **State:** Context API + Hooks (No Redux).

### ğŸ Backend
- **Core:** Python 3.11, FastAPI.
- **Validation:** Pydantic v2 (Use `model_validate`, `field_validator`).
- **Database:** PostgreSQL (Latest).
- **ORM:** SQLAlchemy 2.0 (**SYNCHRONOUS**).
  - ğŸ›‘ **WARNING:** Do NOT use `AsyncSession` or `await` for DB calls.
  - âœ… **USE:** `Session`, `db.execute()`, `db.commit()`.

---

## ğŸ—ï¸ ARCHITECTURE (STRICT)

### 1. Backend (FastAPI + Sync DB)
- **Concurrency:** Use standard `def` for endpoints interacting with the DB (FastAPI runs them in threadpool).
- **Structure:** `routes/` -> calls -> `services/` -> calls -> `models/`
- **Dependency Injection:** Use `db: Session = Depends(get_db)`.
- **Refactor:** Endpoint > 50 lines â†’ Move logic to `services/`.

### 2. Frontend Services (Modular)
- **Pattern:** Modular Service Layer.
- **Import:** `import { apiService } from '../services';`
- **Usage:** `await apiService.patients.getPatients()`
- **Forbidden:** NEVER use generic `api.get()` inside components.

---

## ğŸ’» CODING STANDARDS

### Frontend (React 19 + MUI v7)
- **Hooks:** Prefix `use`. Logic goes here, not in JSX.
- **Styling:** Use MUI `Grid` (v2 if avail) and `Stack` for layout. Avoid raw CSS.
- **Logging:** Use `logger.debug/info/error`. **NO `console.log`**.
- **Error UI:** Use `useScrollToError` in forms. Red background errors.

### Backend (Python)
- **Typing:** Strict Type Hints (`def get_user(id: int) -> UserSchema:`).
- **Pydantic:** Define schemas in `schemas.py`. Use strict types.
- **Error Handling:** `try/except` -> Log (`api_logger`) -> Raise `HTTPException`.

---

## ğŸš« ANTI-PATTERNS (Negative Constraints)
The following are strictly forbidden:
1.  âŒ **Async DB:** Using `await db.execute()` (Since we are using Sync SQLAlchemy).
2.  âŒ **Vite Configs:** Trying to edit `vite.config.ts` (We use CRA/Webpack).
3.  âŒ **Mixing Logic/UI:** API calls directly inside `.tsx` files.
4.  âŒ **Legacy Imports:** Importing from `services/api.ts` (Use modular services).
5.  âŒ **Security Leaks:** Committing `keys`, `passwords`, or `env` vars.
6.  âŒ **Local Runs:** Running `npm start` outside Docker.

---

## ğŸ“‚ DIRECTORY MAP
- **Backend Services:** `backend/services/{domain}_service.py`
- **Frontend Services:** `frontend/src/services/{domain}/{Domain}Service.ts`
- **Components:** `frontend/src/components/{category}/{Component}/{Component}.tsx`
- **Migrations:** `backend/migrations/` (SQL files)

---

## ğŸ§ª VERIFICATION CHECKLIST
1.  **Docker:** Did you run this in Docker?
2.  **Sync Check:** Did you use synchronous DB calls (`def endpoint`, not `async def`)?
3.  **Logs:** Did you use the structured `logger`?
4.  **Responsiveness:** Is the UI responsive on `xs`?