# ðŸš€ Digital Ocean Deployment Guide (Docker + Doppler)

This guide will help you deploy your Medical Records application to a Digital Ocean Droplet using Docker and Doppler for secret management.

## Prerequisites

1.  **Digital Ocean Droplet**: Ubuntu 22.04 or 24.04 (recommended).
2.  **IP Address**: The public IP of your droplet.
3.  **SSH Access**: You should be able to `ssh root@<your-ip>`.
4.  **Doppler Account**: You need a Doppler account and a project created.

## Step 1: Connect to your Droplet

Open your terminal and connect to your server:

```bash
ssh root@<YOUR_DROPLET_IP>
```

If you are asked to confirm the host authenticity, type `yes`.

## Step 2: Install Docker & Doppler

Run the following commands on your server to install the necessary tools.

### Install Docker

```bash
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install -y ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# Install Docker packages:
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

### Install Doppler CLI

```bash
# Install Gnupg
sudo apt-get update && sudo apt-get install -y apt-transport-https ca-certificates curl gnupg

# Add Doppler's GPG key
curl -sLf --retry 3 --tlsv1.2 --proto "=https" 'https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key' | sudo gpg --dearmor -o /usr/share/keyrings/doppler-archive-keyring.gpg

# Add Doppler repo
echo "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main" | sudo tee /etc/apt/sources.list.d/doppler-cli.list

# Install Doppler
sudo apt-get update && sudo apt-get install -y doppler
```

## Step 3: Setup Project Code

You can either clone your repository (if it's on GitHub/GitLab) or copy the files from your local machine.

### Option A: Git Clone (Recommended)

1.  Generate an SSH key on the server (if needed for private repos):
    ```bash
    ssh-keygen -t ed25519 -C "server@digitalocean"
    cat ~/.ssh/id_ed25519.pub
    ```
    Add this key to your GitHub/GitLab "Deploy Keys".

2.  Clone the repo:
    ```bash
    git clone <YOUR_REPO_URL> app
    cd app
    ```

### Option B: Copy Files (SCP)

From your **LOCAL** machine:

```bash
# Compress the project (excluding node_modules, venv, etc)
tar -czf app.tar.gz --exclude='node_modules' --exclude='venv' --exclude='.git' .

# Copy to server
scp app.tar.gz root@<YOUR_DROPLET_IP>:~/

# On the SERVER:
mkdir app
tar -xzf app.tar.gz -C app
cd app
```

## Step 4: Configure Doppler

On the server (inside the `app` directory):

1.  Login to Doppler:
    ```bash
    doppler login
    ```
    (You will need to copy the auth code and visit the URL provided).

2.  Select your project and config (Production):
    ```bash
    doppler setup
    ```
    Select your project (e.g., `cortex`) and the config (e.g., `prd` or `production`).

## Step 5: Deploy!

Now you are ready to start the application using the production compose file.

```bash
doppler run -- docker compose -f compose.prod.yaml up -d --build
```

This command will:
1.  Inject secrets from Doppler.
2.  Build the Docker images (Frontend and Backend).
3.  Start the containers in detached mode.

## Verification

Check if everything is running:

```bash
docker compose -f compose.prod.yaml ps
```

View logs:
```bash
docker compose -f compose.prod.yaml logs -f
```

Your application should now be accessible at `http://<YOUR_DROPLET_IP>:3000`.

## Troubleshooting

-   **Database Connection**: Ensure `DATABASE_URL` or Postgres credentials in Doppler match what the backend expects.
-   **Ports**: Ensure Digital Ocean firewall allows traffic on ports 3000 (Frontend) and 8000 (Backend).
